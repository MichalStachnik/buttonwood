import type { NextPage } from 'next';
import { useState } from 'react';
import { getTokenInfo } from 'erc20-token-list';
import { Contract, getDefaultProvider, providers, utils } from 'ethers';

import Head from 'next/head';

import DropdownToken from '../components/DropdownToken/DropdownToken';
import TokenRow from '../components/TokenRow/TokenRow';
import Spinner from '../components/Loader/Loader';
import styles from '../styles/index.module.css';

const ERC20TokenList = ['USDC', 'UNI', 'WBTC'];

const initWeb3Provider = (): providers.Web3Provider =>
  new providers.Web3Provider((window as any).ethereum);

// TODO: get keys for infura and alchemy

const Home: NextPage = () => {
  const [displayInfo, setDisplayInfo] = useState('');

  const getAccount = async () => {
    console.log('getting accnt...');
    console.log((window as any).ethereum);
    console.log(typeof window.ethereum);

    const accounts = await window.ethereum.request({
      method: 'eth_requestAccounts',
    });

    console.log('accounts', accounts);
    const [account] = accounts;
    setDisplayInfo(account);
    return account;
  };

  const getWalletBalance = async (): Promise<string> => {
    const address = await getAccount();

    const provider = initWeb3Provider();

    const balance = await provider.getBalance(address);

    console.log('the balance we got', balance);

    const formattedBalance = utils.formatEther(balance);

    console.log('formattedBalance', formattedBalance);
    setDisplayInfo(formattedBalance);
    return formattedBalance;
  };

  return (
    <div className={styles.container}>
      <Head>
        <title>Buttonwood</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link
          rel="preconnect"
          href="https://fonts.gstatic.com"
          crossOrigin=""
        />
        <link
          href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400&display=swap"
          rel="stylesheet"
        />
      </Head>

      <main className={styles.main}>
        <div className={styles.dashboard}>
          <div className={styles.result}>
            <span className={styles.display}>
              <p>{displayInfo}</p>
            </span>
            <span className={styles.display}></span>
            <span className={styles.display}></span>
          </div>
          <div className={styles.controls}>
            <div className={styles.buttonContainer}>
              <button onClick={getAccount}>wallet address</button>
              <button onClick={getWalletBalance}>ETH balance</button>
            </div>
            {ERC20TokenList.map(token => (
              <TokenRow key={token} token={token} />
            ))}
          </div>
        </div>
      </main>
    </div>
  );
};

export default Home;
